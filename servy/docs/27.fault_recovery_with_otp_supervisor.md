# Fault Recovery with OTP Supervisor

## 강의 주요 내용

* Supervisor 개념
* Supervisor children 등록
* 
### 1. Supervisor 개념

* GenServer를 위한 Supervisor를 배운다.

![[프로세스링크 1.png]]

### 2. Supervisor children 등록

* OTP Supervisor는 children을 등록하고, children의 `start_link` 함수를 호출한다.
```elixir
defmodule Servy.ServicesSupervisor do
  ## Supervisor 프로세스임을 명시
  use Supervisor  

  def start_link do
    IO.puts "Starting the services supervisor..."
    ## start_link 함수를 호출하면, init 함수가 호출됨
    Supervisor.start_link(__MODULE__, :ok, name: __MODULE__)
  end  

  def init(:ok) do
    children = [
      Servy.PledgeServer,
      Servy.SensorServer
    ]

	## children의 start_link 함수를 호출함
	## one_for_one 옵션은 하나의 children이 종료되면, 그 프로세스만 재기동
	## one_for_all 옵션을 넣으면, 하나가 종료되더라도 전체를 재기동
    Supervisor.init(children, strategy: :one_for_one)
  end
end
```

```elixir
iex(1)> {:ok, sup_pid} = Servy.ServicesSupervisor.start_link()
Starting the services supervisor...
Starting the pledge server...
Starting the sensor server...
Running tasks to get sensor data...
{:ok, #PID<0.204.0>}

iex(2)> Supervisor.which_children(sup_pid)
[
  {Servy.SensorServer, #PID<0.206.0>, :worker, [Servy.SensorServer]},
  {Servy.PledgeServer, #PID<0.205.0>, :worker, [Servy.PledgeServer]}
]

iex(3)> Supervisor.count_children(sup_pid)
%{active: 2, workers: 2, supervisors: 0, specs: 2}

## 종료와 동시에 다시 서버가 시작되는 로그를 볼수 있다.
iex(4)> Process.whereis(:sensor_server) |> Process.exit(:kaboom)
true
Starting the sensor server...
Running tasks to get sensor data...
```