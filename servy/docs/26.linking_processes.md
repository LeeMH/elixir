# Another GenServer

## ê°•ì˜ ì£¼ìš” ë‚´ìš©

* OTP ì„œë²„ì˜ ëª¨ë‹ˆí„°ë§, restart ê°œë…
* HTTPServer ëª¨ë‹ˆí„°ë§, restart ì „ìš© KickStarter ì„œë²„ ì¶”ê°€
* KickStarter, HTTPServer link
* KickStarter -> HTTPServer ëª¨ë‹ˆí„°ë§ í•˜ë„ë¡ ê°œì„ 

### 1. OTP ì„œë²„ì˜ ëª¨ë‹ˆí„°ë§, restart ê°œë…

* elixirëŠ” ì „í™” êµí™˜ë§ìœ¼ë¡œ ê°œë°œëœ erlang ìœ„ì—ì„œ ì‹¤í–‰ë˜ëŠ” ì–¸ì–´ì´ë‹¤.
* GenServerëŠ” OTP Supervisorë¡œ ëª¨ë‹ˆí„°ë§, ì¬ê¸°ë™ì´ ê°€ëŠ¥í•˜ë‹¤.
* ìš°ì„  ì¼ë°˜ í”„ë¡œì„¸ìŠ¤ì¸ HTTPServer ì „ìš© KickStarterë¥¼ ë§Œë“¤ë©°, Supervisor ê¸°ëŠ¥ì´ ì–´ë–»ê²Œ ëŒì•„ê°€ëŠ”ì§€ ì´í•´í•´ ë³¸ë‹¤.

![[í”„ë¡œì„¸ìŠ¤ë§í¬.png]]

### 2. HTTPServer ëª¨ë‹ˆí„°ë§, restart ì „ìš© KickStarter ì„œë²„ ì¶”ê°€

* init í•¨ìˆ˜ë¥¼ í†µí•´ HTTPServerë¥¼ start ì‹œí‚¤ê³ , í”„ë¡œì„¸ìŠ¤ë¡œ ë“±ë¡í•œë‹¤.
```elixir
defmodule Servy.KickStarter do
Â  use GenServer  

Â  def start do
Â  Â  IO.puts "Starting the kickstarter"
Â  Â  GenServer.start(__MODULE__, :ok, name: __MODULE__)
Â  end  

Â  def init(:ok) do
Â  Â  IO.puts "Starting the HTTP server..."
Â  Â  ## HTTPServerë¥¼ ê¸°ë™í•˜ê³ , í”„ë¡œì„¸ìŠ¤ë¥¼ ë“±ë¡í•œë‹¤.
Â  Â  server_pid = spawn(Servy.HttpServer, :start, [4000])
Â  Â  Process.register(server_pid, :http_server)
Â  Â  {:ok, server_pid}
Â  end
end
```


```elixir
## KickStarter ì„œë²„ë¥¼ ê¸°ë™í•œë‹¤.
## initì—ì„œ HTTPServerë¥¼ ë™ì‹œì— ê¸°ë™í•˜ëŠ” ë¡œê·¸ê°€ ì¶œë ¥ëœë‹¤.
iex(1)> {:ok, kick_pid} = Servy.KickStarter.start()
Starting the kickstarter
Starting the HTTP server...

ğŸ§  Listening for connection requests on port 4000...

âŒ›ï¸  Waiting to accept a client connection...

{:ok, #PID<0.201.0>}

## HTTPServer PIDë¥¼ í™•ì¸í•œë‹¤.
iex(2)> server_pid = Process.whereis(:http_server)
#PID<0.202.0>

## HTTPServerë¥¼ ì¢…ë£Œí•œë‹¤.
iex(3)> Process.exit(server_pid, :kaboom)
true

## HTTPServerê°€ ì¢…ë£Œëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
iex(4)> Process.alive?(server_pid)
false

## KickStarter ì„œë²„ëŠ” ì¢…ë£Œë˜ì§€ ì•Šì•˜ë‹¤.
iex(5)> Process.alive?(kick_pid)
true
```

### 3. KickStarter, HTTPServer link

* KickStarterì™€ HTTPServerë¥¼ ì—°ê²°í•œë‹¤.
* linkë¡œ ì—°ê²°í•˜ëŠ” ê²½ìš°, `ì—°ê²°ì€ ì–‘ë°©í–¥`ì´ë‹¤.
```elixir
defmodule Servy.KickStarter do
  ...
  ...
Â  def init(:ok) do
Â  Â  IO.puts "Starting the HTTP server..."
Â  Â  server_pid = spawn(Servy.HttpServer, :start, [4000])

    ## KickStarterì™€ HTTPServerë¥¼ link í•œë‹¤.
Â  Â  Process.link(server_pid)
Â  Â  Process.register(server_pid, :http_server)
Â  Â  {:ok, server_pid}
Â  end
end
```

```elixir
iex(1)> {:ok, kick_pid} = Servy.KickStarter.start()
Starting the kickstarter
Starting the HTTP server...

ğŸ§  Listening for connection requests on port 4000...

âŒ›ï¸  Waiting to accept a client connection...

{:ok, #PID<0.200.0>}

iex(2)> server_pid = Process.whereis(:http_server)
#PID<0.201.0>

## ì—°ê²°ëœ í”„ë¡œì„¸ë¥¼ í™•ì¸ê°€ëŠ¥í•˜ë‹¤.
iex(3)> Process.info(kick_pid, :links)
{:links, [#PID<0.201.0>]}

## HTTPServer ì—­ì‹œ KickStarterê°€ ì—°ê²°ë˜ì–´ ìˆë‹¤.
iex(4)> Process.info(server_pid, :links)
{:links, [#PID<0.200.0>, #Port<0.4>]}

## HTTPServer ì¢…ë£Œ
iex(5)> Process.exit(server_pid, :kaboom)
true

## ì•ì˜ ì˜ˆì œì™€ ë‹¤ë¥´ê²Œ, KickStarterë„ ì¢…ë£Œë˜ì–´ ìˆë‹¤.
iex(6)> Process.alive?(kick_pid)
false
```

### 4. KickStarter -> HTTPServer ëª¨ë‹ˆí„°ë§ í•˜ë„ë¡ ê°œì„ 

* exit ì‹œê·¸ë„ ì²˜ë¦¬
```elixir
Â  def init(:ok) do
Â    ## í•´ë‹¹ ì‹œê·¸ë„ì„ ë°›ë”ë¼ë„, ê°™ì´ ì¢…ë£Œë˜ì§€ ì•Šê²Œ ì„¤ì •í•œë‹¤.
Â  Â  Process.flag(:trap_exit, true)
Â  Â  IO.puts "Starting the HTTP server..."
Â  Â  server_pid = spawn(Servy.HttpServer, :start, [4000])
Â  Â  Process.link(server_pid)
Â  Â  Process.register(server_pid, :http_server)
Â  Â  {:ok, server_pid}
Â  end
```

```elixir
iex(1)> {:ok, kick_pid} = Servy.KickStarter.start()
Starting the kickstarter
Starting the HTTP server...

ğŸ§  Listening for connection requests on port 4000...

âŒ›ï¸  Waiting to accept a client connection...

{:ok, #PID<0.200.0>}

iex(2)> server_pid = Process.whereis(:http_server)
#PID<0.201.0>

## HTTPServer ì¢…ë£Œ
iex(3)> Process.exit(server_pid, :kaboom)
true

## KickStarterì—ì„œ ì•„ë˜ ë©”ì„¸ì§€ë¥¼ ìˆ˜ì‹ í–ˆë‹¤ëŠ” ëœ»ì´ë‹¤.
## handle_info í•¨ìˆ˜ë¥¼ í†µí•´ ì•„ë˜ ë©”ì„¸ì§€ë¥¼ í•¸ë“¤ë§í•˜ê³ , HTTPServerë¥¼ ì¬ê¸°ë™í•˜ë©´ ëœë‹¤.
11:59:14.506 [error] Servy.KickStarter Servy.KickStarter received unexpected message in handle_info/2: {:EXIT, #PID<0.201.0>, :kaboom}

## KickStarterëŠ” ì¢…ë£Œë˜ì§€ ì•Šì•˜ë‹¤!!!
iex(4)> Process.alive?(kick_pid)
true
```